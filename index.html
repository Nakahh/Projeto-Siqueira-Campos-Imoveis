<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#8B4513" />

    <!-- Performance optimizations -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="dns-prefetch" href="//images.unsplash.com" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

    <!-- SEO Meta Tags -->
    <meta
      name="description"
      content="Sistema completo de gest√£o imobili√°ria - Siqueira Campos Im√≥veis. Encontre seu im√≥vel ideal em Goi√¢nia com seguran√ßa e profissionalismo."
    />
    <meta
      name="keywords"
      content="im√≥veis, casa, apartamento, venda, aluguel, Goi√¢nia, Siqueira Campos, gest√£o imobili√°ria"
    />
    <meta name="author" content="KRYONIX Tecnologia" />
    <meta name="robots" content="index, follow" />

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Siqueira Campos" />

    <!-- Social Media Meta Tags -->
    <meta property="og:title" content="Siqueira Campos Im√≥veis" />
    <meta
      property="og:description"
      content="Sistema completo de gest√£o imobili√°ria profissional"
    />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="pt_BR" />

    <title>Siqueira Campos Im√≥veis - Sistema Profissional</title>

    <!-- ULTIMATE ANTI-LOOP DEBUG SYSTEM -->
    <script>
      // EMERGENCY ANTI-LOOP PROTECTION SYSTEM
      // This is a comprehensive debug and protection system

      let pageLoadCount = parseInt(
        localStorage.getItem("siqueiraPageLoads") || "0",
      );
      pageLoadCount++;
      localStorage.setItem("siqueiraPageLoads", pageLoadCount.toString());

      const startTime = Date.now();
      const lastLoad = parseInt(
        localStorage.getItem("siqueiraLastLoad") || "0",
      );
      const timeSinceLastLoad = startTime - lastLoad;
      localStorage.setItem("siqueiraLastLoad", startTime.toString());

      console.log(
        `üîç [SIQUEIRA DEBUG] Page load #${pageLoadCount}, time since last: ${timeSinceLastLoad}ms`,
      );

      // DETECT INFINITE LOOP
      if (pageLoadCount > 5 && timeSinceLastLoad < 30000) {
        // 30 seconds
        console.error("üö® [EMERGENCY] Infinite reload loop detected!");

        // EMERGENCY STOP
        document.documentElement.innerHTML = `
          <div style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
            color: white;
            font-family: system-ui, -apple-system, sans-serif;
            text-align: center;
            padding: 2rem;
          ">
            <div style="
              background: rgba(255,255,255,0.1);
              backdrop-filter: blur(10px);
              border-radius: 1rem;
              padding: 3rem;
              max-width: 700px;
              box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            ">
              <h1 style="font-size: 2.5rem; margin-bottom: 1rem; font-weight: bold;">
                üõ°Ô∏è PROTE√á√ÉO ANTI-LOOP ATIVADA
              </h1>
              <h2 style="font-size: 1.5rem; margin-bottom: 1rem; color: #FEE2E2;">
                Siqueira Campos Im√≥veis - Sistema Protegido
              </h2>
              <p style="font-size: 1.1rem; margin-bottom: 2rem;">
                Desenvolvido por <strong>KRYONIX Tecnologia</strong>
              </p>
              
              <div style="
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 0.5rem;
                padding: 1.5rem;
                margin-bottom: 2rem;
                text-align: left;
              ">
                <h3 style="color: #FEE2E2; margin-bottom: 1rem;">üö® Loop Infinito Detectado</h3>
                <p style="font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 1rem;">
                  Sistema detectou ${pageLoadCount} recarregamentos em ${Math.round(timeSinceLastLoad / 1000)}s e ativou prote√ß√£o autom√°tica.
                </p>
                <p style="font-size: 0.9rem; color: rgba(255,255,255,0.9);">
                  <strong>Poss√≠veis causas:</strong><br/>
                  ‚Ä¢ Erro de roteamento do React Router<br/>
                  ‚Ä¢ Problema no AuthContext<br/>
                  ‚Ä¢ Conflito de depend√™ncias<br/>
                  ‚Ä¢ Hook useEffect mal configurado
                </p>
              </div>
              
              <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button onclick="
                  localStorage.removeItem('siqueiraPageLoads');
                  localStorage.removeItem('siqueiraLastLoad');
                  window.location.reload();
                " style="
                  padding: 1rem 2rem;
                  background: white;
                  color: #DC2626;
                  border: none;
                  border-radius: 0.5rem;
                  font-size: 1.1rem;
                  font-weight: bold;
                  cursor: pointer;
                  transition: all 0.3s ease;
                ">üîÑ Reset e Tentar Novamente</button>
                
                <button onclick="window.open('https://wa.me/5517981805327?text=EMERG√äNCIA%20-%20Loop%20infinito%20detectado%20no%20sistema%20Siqueira%20Campos', '_blank')" style="
                  padding: 1rem 2rem;
                  background: rgba(255,255,255,0.1);
                  color: white;
                  border: 1px solid rgba(255,255,255,0.3);
                  border-radius: 0.5rem;
                  font-size: 1.1rem;
                  font-weight: bold;
                  cursor: pointer;
                  transition: all 0.3s ease;
                ">üÜò Emerg√™ncia KRYONIX</button>
              </div>
            </div>
          </div>
        `;

        // STOP ALL SCRIPTS
        throw new Error("EMERGENCY STOP - Infinite loop detected");
      }

      // Enhanced performance tracking
      window.SiqueiraPerf = {
        start: Date.now(),
        marks: {},
        pageLoads: pageLoadCount,
        timeSinceLastLoad: timeSinceLastLoad,
      };

      // Mark performance points
      const mark = (name) => {
        window.SiqueiraPerf.marks[name] =
          Date.now() - window.SiqueiraPerf.start;
      };

      mark("html-parsed");

      console.log(
        "üöÄ Sistema Siqueira Campos Im√≥veis v2.0 - KRYONIX Technology (PROTECTED MODE)",
      );

      // Enhanced environment detection with anti-loop monitoring
      window.SiqueiraDebug = {
        startTime: Date.now(),
        logs: [],
        errors: [],
        performance: window.SiqueiraPerf,
        loopProtection: {
          pageLoads: pageLoadCount,
          timeSinceLastLoad: timeSinceLastLoad,
          isInLoop: pageLoadCount > 5 && timeSinceLastLoad < 30000,
        },
        environment: {
          url: window.location.href,
          userAgent: navigator.userAgent,
          viewport: { width: window.innerWidth, height: window.innerHeight },
          timestamp: new Date().toISOString(),
          isDev: window.location.hostname === "localhost",
        },
      };

      // Professional logging system with anti-spam
      const logCache = new Map();
      const log = (level, message, data = null) => {
        const logKey = `${level}:${message}`;
        const now = Date.now();
        const lastLog = logCache.get(logKey) || 0;

        // Anti-spam: only log same message once per 5 seconds
        if (now - lastLog < 5000) {
          return;
        }
        logCache.set(logKey, now);

        const entry = {
          level,
          message,
          data,
          timestamp: Date.now() - window.SiqueiraDebug.startTime,
          stack: new Error().stack,
        };
        window.SiqueiraDebug.logs.push(entry);

        // Only log in development
        if (window.SiqueiraDebug.environment.isDev) {
          console[level](`[${entry.timestamp}ms] ${message}`, data || "");
        }
      };

      log(
        "info",
        "üè† Sistema Siqueira Campos Im√≥veis v2.0 - KRYONIX Technology",
      );
      log("info", "üîç Ambiente detectado", window.SiqueiraDebug.environment);
      log(
        "info",
        "üõ°Ô∏è Prote√ß√£o anti-loop ativa",
        window.SiqueiraDebug.loopProtection,
      );

      // COMPREHENSIVE FETCH MONITORING
      const originalFetch = window.fetch;
      window.fetch = function (url, options) {
        const urlString = typeof url === "string" ? url : url.toString();
        const startTime = Date.now();

        log("info", "üì° Fetch iniciado", { url: urlString, options });

        return originalFetch.apply(this, arguments).then(
          (response) => {
            const duration = Date.now() - startTime;
            log("info", "üì° Fetch conclu√≠do", {
              url: urlString,
              status: response.status,
              duration: `${duration}ms`,
            });
            return response;
          },
          (error) => {
            const duration = Date.now() - startTime;
            log("error", "üì° Fetch falhou", {
              url: urlString,
              error: error.message,
              duration: `${duration}ms`,
            });
            throw error;
          },
        );
      };

      // LOCATION CHANGE MONITORING
      const originalReplace = window.location.replace;
      const originalAssign = window.location.assign;

      window.location.replace = function (url) {
        log("warn", "üîÑ Location.replace called", {
          url,
          stack: new Error().stack,
        });
        return originalReplace.call(this, url);
      };

      window.location.assign = function (url) {
        log("warn", "üîÑ Location.assign called", {
          url,
          stack: new Error().stack,
        });
        return originalAssign.call(this, url);
      };

      // Monitor href changes
      Object.defineProperty(window.location, "href", {
        set: function (url) {
          log("warn", "üîÑ Location.href set", {
            url,
            stack: new Error().stack,
          });
          return url;
        },
        get: function () {
          return window.location.href;
        },
      });

      // Enhanced error tracking with stack traces
      window.addEventListener("error", (event) => {
        const errorInfo = {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          error: event.error,
          timestamp: Date.now(),
          stack: event.error?.stack,
        };
        window.SiqueiraDebug.errors.push(errorInfo);
        log("error", "‚ùå JavaScript Error Detected", errorInfo);
      });

      window.addEventListener("unhandledrejection", (event) => {
        const errorInfo = {
          reason: event.reason,
          promise: event.promise,
          timestamp: Date.now(),
        };
        window.SiqueiraDebug.errors.push(errorInfo);
        log("error", "‚ùå Unhandled Promise Rejection", errorInfo);
      });

      mark("debug-initialized");
      log(
        "info",
        "‚úÖ Enhanced debug system with anti-loop protection initialized",
      );
    </script>

    <!-- Preload critical resources -->
    <link rel="modulepreload" href="/client/main.tsx" />
    <link rel="modulepreload" href="/client/App.tsx" />
    <link rel="stylesheet" href="/client/global.css" />
  </head>

  <body>
    <div id="root">
      <!-- Enhanced professional loading state with loop detection -->
      <div
        id="loading-state"
        style="
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          background: linear-gradient(135deg, #8b4513 0%, #d2b48c 100%);
          color: white;
          font-family:
            system-ui,
            -apple-system,
            BlinkMacSystemFont,
            &quot;Segoe UI&quot;,
            sans-serif;
          text-align: center;
          padding: 2rem;
        "
      >
        <div
          style="
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            padding: 3rem;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.8s ease-out;
          "
        >
          <h1 style="font-size: 3rem; margin-bottom: 1rem; font-weight: bold">
            üè† Siqueira Campos Im√≥veis
          </h1>
          <p style="font-size: 1.3rem; margin-bottom: 1rem; color: #ffe4b5">
            Sistema Profissional de Gest√£o Imobili√°ria v2.0
          </p>
          <p style="font-size: 1.1rem; margin-bottom: 2rem">
            Desenvolvido por <strong>KRYONIX Tecnologia</strong>
          </p>

          <div
            id="loading-progress"
            style="
              background: rgba(255, 255, 255, 0.2);
              border-radius: 0.5rem;
              padding: 1.5rem;
              margin-bottom: 2rem;
            "
          >
            <div
              style="
                width: 100%;
                height: 6px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 3px;
                margin-bottom: 1rem;
                overflow: hidden;
              "
            >
              <div
                id="progress-bar"
                style="
                  width: 0%;
                  height: 100%;
                  background: linear-gradient(90deg, #ffe4b5, #ffffff);
                  border-radius: 3px;
                  transition: width 0.3s ease;
                  animation: progressPulse 2s infinite;
                "
              ></div>
            </div>
            <p
              id="loading-text"
              style="color: #ffe4b5; margin: 0; font-size: 0.9rem"
            >
              üîß Inicializando sistema React v2.0 com prote√ß√£o anti-loop...
            </p>
          </div>

          <div
            id="system-info"
            style="
              font-size: 0.85rem;
              color: rgba(255, 255, 255, 0.8);
              line-height: 1.5;
            "
          >
            <p>‚úÖ Sistema multi-dashboard enterprise ativo</p>
            <p>‚úÖ PWA profissional v2.0 configurado</p>
            <p>‚úÖ Seguran√ßa enterprise aprimorada</p>
            <p>‚úÖ API REST otimizada funcionando</p>
            <p>‚úÖ Performance monitoring ativo</p>
            <p>üõ°Ô∏è Prote√ß√£o anti-loop ATIVA</p>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="/client/main.tsx"></script>

    <!-- Enhanced Service Worker Management with Loop Protection -->
    <script>
      mark("scripts-loading");

      let loadingProgress = 0;
      const updateProgress = (percentage, text) => {
        loadingProgress = Math.min(percentage, 100);
        const progressBar = document.getElementById("progress-bar");
        const loadingText = document.getElementById("loading-text");
        if (progressBar) progressBar.style.width = loadingProgress + "%";
        if (loadingText) loadingText.textContent = text;
        log("info", "üìä Loading progress", {
          percentage: loadingProgress,
          text,
        });
      };

      updateProgress(10, "üîß Carregando recursos do sistema...");

      // Enhanced script loading monitoring
      const scripts = document.querySelectorAll("script[src]");
      let scriptsLoaded = 0;

      scripts.forEach((script) => {
        script.addEventListener("load", () => {
          scriptsLoaded++;
          const progress = 10 + (scriptsLoaded / scripts.length) * 50;
          updateProgress(
            progress,
            `üì¶ Carregando componentes (${scriptsLoaded}/${scripts.length})...`,
          );
        });

        script.addEventListener("error", (e) => {
          log("error", "‚ùå Script loading failed", {
            src: script.src,
            error: e,
          });
        });
      });

      // Enhanced Service Worker with comprehensive error handling
      if ("serviceWorker" in navigator) {
        updateProgress(70, "üîÑ Configurando Service Worker...");

        window.addEventListener("load", function () {
          navigator.serviceWorker
            .register("/sw.js")
            .then((registration) => {
              log(
                "info",
                "‚úÖ Service Worker registered successfully",
                registration,
              );
              updateProgress(85, "‚úÖ Service Worker ativo");
            })
            .catch((error) => {
              log(
                "warn",
                "‚ö†Ô∏è Service Worker registration failed (normal for development)",
                error,
              );
              updateProgress(85, "‚ö†Ô∏è Service Worker opcional (modo dev)");
            });
        });
      } else {
        updateProgress(85, "‚ö†Ô∏è Service Worker n√£o suportado");
      }

      // Enhanced timeout fallback with emergency protection
      const maxLoadingTime = 20000; // 20 seconds
      const fallbackTimeout = setTimeout(() => {
        const loadingState = document.getElementById("loading-state");
        if (loadingState && loadingState.style.display !== "none") {
          updateProgress(
            100,
            "‚è∞ Timeout detectado - Sistema pode estar em loop",
          );
          log("error", "‚è∞ Loading timeout - poss√≠vel loop infinito detectado");

          const loadingText = document.getElementById("loading-text");
          if (loadingText) {
            loadingText.innerHTML = `
              <div style="color: #FFE4B5; margin-bottom: 1rem;">
                ‚ö†Ô∏è Sistema demorou mais que o esperado para carregar
              </div>
              <button onclick="
                localStorage.removeItem('siqueiraPageLoads');
                localStorage.removeItem('siqueiraLastLoad');
                window.location.reload();
              " style="
                padding: 1rem 2rem;
                background: white;
                color: #8B4513;
                border: none;
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: bold;
                cursor: pointer;
                margin-top: 1rem;
                transition: all 0.3s ease;
              ">üîÑ Reset Sistema</button>
              <button onclick="window.open('https://wa.me/5517981805327?text=Problema%20de%20carregamento%20no%20sistema%20Siqueira%20Campos', '_blank')" style="
                padding: 1rem 2rem;
                background: rgba(255,255,255,0.1);
                color: white;
                border: 1px solid rgba(255,255,255,0.3);
                border-radius: 0.5rem;
                font-size: 1rem;
                font-weight: bold;
                cursor: pointer;
                margin-left: 1rem;
                margin-top: 1rem;
                transition: all 0.3s ease;
              ">üí¨ Suporte</button>
            `;
          }
        }
      }, maxLoadingTime);

      // Clear timeout when app loads successfully
      window.addEventListener("load", () => {
        clearTimeout(fallbackTimeout);
        mark("page-loaded");
      });

      mark("loading-system-initialized");
      log(
        "info",
        "‚úÖ Enhanced loading system v2.0 with anti-loop protection initialized",
      );
    </script>

    <!-- CSS animations for enhanced UX -->
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes progressPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* Performance optimizations */
      * {
        box-sizing: border-box;
      }

      html {
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
      }

      #root {
        min-height: 100vh;
      }
    </style>
  </body>
</html>
